<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Caqti_request (caqti.Caqti_request)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">caqti</a> &#x00BB; Caqti_request</nav><h1>Module <code>Caqti_request</code></h1><p>Request specification.</p><p>A Caqti request is a function to generate a query string from information about the driver, along with type descriptors to encode parameters and decode rows returned from the same query. Requests are passed to <a href="../Caqti_connection_sig/module-type-S/index.html#val-call"><code>Caqti_connection_sig.S.call</code></a> or one of its shortcut methods provided by a database connection handle.</p><p>The request often represent a prepared query, in which case it is static and can be defined directly in a module scope. However, an optional <code>oneshot</code> parameter may be passed to indicate a dynamically generated query.</p><nav class="toc"><ul><li><a href="#primitives">Primitives</a></li><li><a href="#convenience">Convenience</a></li><li><a href="#how-to-dynamically-assemble-queries-and-parameters">How to Dynamically Assemble Queries and Parameters</a></li></ul></nav></header><section><header><h3 id="primitives"><a href="#primitives" class="anchor"></a>Primitives</h3></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>('a, 'b, +'m) t</span></code><code> <span class="keyword">constraint</span> <span class="type-var">'m</span> = <span>[&lt; `Zero <span>| `One</span> <span>| `Many</span> ]</span></code></dt><dd><p>A request specification embedding a query generator, parameter encoder, and row decoder.</p><ul><li><code>'a</code> is the type of the expected parameter bundle.</li><li><code>'b</code> is the type of a returned row.</li><li><code>'m</code> is the possible multiplicities of returned rows.</li></ul></dd></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;oneshot:bool</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'m</span> <a href="../Caqti_mult/index.html#type-t">Caqti_mult.t</a></span> <span>&#45;&gt;</span> <span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>create arg_type row_type row_mult f</code> is a request which takes parameters of type <code>arg_type</code>, returns rows of type <code>row_type</code> with multiplicity <code>row_mult</code>, and which sends query strings generated from the query <code>f di</code>, where <code>di</code> is the <a href="../Caqti_driver_info/index.html#type-t"><code>Caqti_driver_info.t</code></a> of the target driver. The driver is responsible for turning parameter references into a form accepted by the database, while other differences must be handled by <code>f</code>.</p><dl><dt>parameter oneshot</dt><dd><p>Disables caching of a prepared statements on connections for this query.</p><ul><li>If false (the default), the statement is prepared and a handle is permanently attached to the connection object right before the first time it is executed.</li></ul><ul><li>If true, everything allocated in order to execute the statement is released after use.</li></ul><p>In other words, the default is suitable for queries which are bound to static modules. Conversely, you should pass <code>~oneshot:true</code> if the query is dynamically generated, whether it is within a function or a dynamic module, since there will otherwise be a memory leak associated with long-lived connections. You might as well also pass <code>~oneshot:true</code> if you know that the query will only executed at most once (or a very few times) on each connection.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-param_type"><a href="#val-param_type" class="anchor"></a><code><span class="keyword">val</span> param_type : <span><span>(<span class="type-var">'a</span>, <span class="type-var">_</span>, <span class="type-var">_</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span></code></dt><dd><p><code>param_type req</code> is the type of parameter bundles expected by <code>req</code>.</p></dd></dl><dl><dt class="spec value" id="val-row_type"><a href="#val-row_type" class="anchor"></a><code><span class="keyword">val</span> row_type : <span><span>(<span class="type-var">_</span>, <span class="type-var">'b</span>, <span class="type-var">_</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span></code></dt><dd><p><code>row_type req</code> is the type of rows returned by <code>req</code>.</p></dd></dl><dl><dt class="spec value" id="val-row_mult"><a href="#val-row_mult" class="anchor"></a><code><span class="keyword">val</span> row_mult : <span><span>(<span class="type-var">_</span>, <span class="type-var">_</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'m</span> <a href="../Caqti_mult/index.html#type-t">Caqti_mult.t</a></span></code></dt><dd><p><code>row_mult req</code> indicates how many rows <code>req</code> may return. This is asserted when constructing the query.</p></dd></dl><dl><dt class="spec value" id="val-query_id"><a href="#val-query_id" class="anchor"></a><code><span class="keyword">val</span> query_id : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>int option</span></code></dt><dd><p>If <code>req</code> is a prepared query, then <code>query_id req</code> is <code>Some id</code> for some <code>id</code> which uniquely identifies <code>req</code>, otherwise it is <code>None</code>.</p></dd></dl><dl><dt class="spec value" id="val-query"><a href="#val-query" class="anchor"></a><code><span class="keyword">val</span> query : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a></code></dt><dd><p><code>query req</code> is the function which generates the query of this request possibly tailored for the given driver.</p></dd></dl></section><section><header><h3 id="convenience"><a href="#convenience" class="anchor"></a>Convenience</h3><p>In the following functions, queries are written out as plain strings with the following syntax, which is parsed by Caqti into a <a href="../Caqti_query/index.html#type-t"><code>Caqti_query.t</code></a> object before being passed to drivers.</p><p><b>Parameters</b> are specified as either</p><ul><li><code>&quot;?&quot;</code> for linear substitutions (like Sqlite and MariaDB), or</li><li><code>&quot;$1&quot;</code>, <code>&quot;$2&quot;</code>, ... for non-linear substitutions (like PostgreSQL).</li></ul><p>Either case works independent of the style used by the database system; if non-linear substitutions are used with a database system which does not support it, the parameter values will be reorderd and duplicated as needed. Mixing the two styles in the same query string is not permitted. Note that numbering of non-linear parameters is offset by one compared to <a href="../Caqti_query/index.html#type-t.P"><code>Caqti_query.t.P</code></a>, in order to be consistent with PostgreSQL conventions.</p><p><b>Static references</b> are references to the <code>?env</code> argument of the functions below, and thus fixed once the query has been constructed. The query parser accepts two forms:</p><ul><li><code>&quot;$(&lt;var&gt;)&quot;</code> is substituted by <code>env driver_info &quot;&lt;var&gt;&quot;</code>.</li><li><code>&quot;$(&lt;var&gt;.)&quot;</code>, if not found by the first rule, is substituted by <code>env driver_info &quot;&lt;var&gt;&quot;</code> followed by a dot iff that result is nonempty.</li><li><code>&quot;$&lt;var&gt;.&quot;</code> is a shortcut for <code>&quot;$(&lt;var&gt;.)&quot;</code>.</li></ul><p>These aid in substituting configurable fragments, like database schemas or table names. The latter form is suggested for qualifying tables, sequences, etc. with the main database schema. It should expand to a schema name followed by a dot, so that the empty string can be returned if the database does not support schemas or no schema is requested by the user.</p><p>Finally,</p><ul><li>Dollar signs in single-quoted strings are left unchanged.</li><li><code>&quot;$&lt;var&gt;$&quot;</code> is left unchanged.</li><li><code>&quot;$$&quot;</code> will be left unchanged in future versions, see the notice below.</li></ul><p>Apart from the more generic <a href="index.html#val-create_p"><code>create_p</code></a>, these function match up with retrieval functions of <a href="../Caqti_connection_sig/module-type-S/index.html"><code>Caqti_connection_sig.S</code></a> and <a href="../Caqti_response_sig/module-type-S/index.html"><code>Caqti_response_sig.S</code></a> according to the multiplicity parameter of their types.</p><p><b>Deprecation of undocumented feature.</b> It has been possible to quote the dollar sign by doubling it. This was undocumented and is hereby deprecated. If you need a literal dollar signs outside quoted strings, add a variable which expands to the dollar sign to the environment.</p></header><dl><dt class="spec value" id="val-create_p"><a href="#val-create_p" class="anchor"></a><code><span class="keyword">val</span> create_p : <span>?&#8288;env:<span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;oneshot:bool</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'m</span> <a href="../Caqti_mult/index.html#type-t">Caqti_mult.t</a></span> <span>&#45;&gt;</span> <span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> string)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>create_p arg_type row_type row_mult f</code> is a request which takes parameters of type <code>arg_type</code>, returns rows of type <code>row_type</code> with multiplicity <code>row_mult</code>, and which sends a query string based on a preliminary form given by <code>f di</code>, where <code>di</code> is the <a href="../Caqti_driver_info/index.html#type-t"><code>Caqti_driver_info.t</code></a> of the target driver. The preliminary query string may contain parameter and static references as described in the introduction of this section.</p><dl><dt>parameter oneshot</dt><dd><p>Disables caching of a prepared statements on connections for this query. See <a href="index.html#val-create"><code>create</code></a> for details.</p></dd></dl><dl><dt>parameter env</dt><dd><p><code>env driver_info key</code> shall provide the value to substitute for a reference to <code>key</code> in the preliminary query string, or raise <code>Not_found</code> to indicate the reference to <code>key</code> is invalid. <code>Not_found</code> will be re-raised as <code>Invalid_argument</code> with additional information to help locate the bug.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-exec"><a href="#val-exec" class="anchor"></a><code><span class="keyword">val</span> exec : <span>?&#8288;env:<span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;oneshot:bool</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, unit, <span>[&gt; `Zero ]</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>exec_p ?env ?oneshot arg_type s</code> is a shortcut for <code>create_p ?env ?oneshot
    arg_type Caqti_type.unit Caqti_mult.zero (fun _ -&gt; s)</code>.</p></dd></dl><dl><dt class="spec value" id="val-find"><a href="#val-find" class="anchor"></a><code><span class="keyword">val</span> find : <span>?&#8288;env:<span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;oneshot:bool</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[&gt; `One ]</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>find_p ?env ?oneshot arg_type row_type s</code> is a shortcut for <code>create_p ?env ?oneshot arg_type row_type Caqti_mult.one (fun _ -&gt; s)</code>.</p></dd></dl><dl><dt class="spec value" id="val-find_opt"><a href="#val-find_opt" class="anchor"></a><code><span class="keyword">val</span> find_opt : <span>?&#8288;env:<span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;oneshot:bool</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[&gt; `Zero <span>| `One</span> ]</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>find_opt_p arg_type ?env ?oneshot row_type s</code> is a shortcut for <code>create_p
    ?env ?oneshot arg_type row_type Caqti_mult.zero_or_one (fun _ -&gt; s)</code>.</p></dd></dl><dl><dt class="spec value" id="val-collect"><a href="#val-collect" class="anchor"></a><code><span class="keyword">val</span> collect : <span>?&#8288;env:<span>(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;oneshot:bool</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[&gt; `Zero <span>| `One</span> <span>| `Many</span> ]</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>collect_p arg_type ?env ?oneshot row_type s</code> is a shortcut for <code>create_p arg_type ?env ?oneshot row_type Caqti_mult.many (fun _ -&gt; s)</code>.</p></dd></dl><dl><dt class="spec value" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : Stdlib.Format.formatter <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>pp ppf req</code> prints <code>req</code> on <code>ppf</code> in a form suitable for human inspection.</p></dd></dl><dl><dt class="spec value" id="val-pp_with_param"><a href="#val-pp_with_param" class="anchor"></a><code><span class="keyword">val</span> pp_with_param : <span>?&#8288;driver_info:<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a></span> <span>&#45;&gt;</span> Stdlib.Format.formatter <span>&#45;&gt;</span> <span>(<span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="index.html#type-t">t</a></span> * <span class="type-var">'a</span>)</span> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>pp_with_param ppf (req, param)</code> prints <code>req</code> and the associated <code>param</code> to <code>ppf</code>. This functions is meant for debugging; the output is neither guaranteed to be consistent across releases nor to contain a complete record of the data.</p><p>Due to concerns about exposure of sensitive data in debug logs, this function reverts to <a href="index.html#val-pp"><code>pp</code></a> unless the environment varibale <code>CAQTI_DEBUG_PARAM</code> is set to <code>true</code>. If you enable it for applications which do not consistenly annotate sensitive parameters with <span class="xref-unresolved" title="unresolved reference to &quot;Caqti_type.redact&quot;"><a href="../Caqti_type/index.html"><code>Caqti_type</code></a>.redact</span>, make sure your debug logs are well secured.</p></dd></dl></section><section><header><h3 id="how-to-dynamically-assemble-queries-and-parameters"><a href="#how-to-dynamically-assemble-queries-and-parameters" class="anchor"></a>How to Dynamically Assemble Queries and Parameters</h3><p>In some cases, queries are constructed dynamically, e.g. when translating an expression for searching a database into SQL. In such cases the number of parameters and their types will typically vary, as well. A helper like the following can be used to existentially pack the parameter types along with the corresponding parameter values to allow collecing them incrementally:</p><pre><code class="ml">module Dynparam = struct
  type t = Pack : 'a Caqti_type.t * 'a -&gt; t
  let empty = Pack (Caqti_type.unit, ())
  let add t x (Pack (t', x')) = Pack (Caqti_type.tup2 t' t, (x', x))
end</code></pre><p>Now, given a <code>param : Dynparam.t</code> and a corresponding query string <code>qs</code>, one can construct a request and execute it:</p><pre><code class="ml">let Dynparam.Pack (pt, pv) = param in
let req = Caqti_request.exec ~oneshot:true pt qs in
C.exec req pv</code></pre><p>Note that dynamically constructed requests should have <code>~oneshot:true</code> unless they are memoized. Also note that it is natural to use <a href="index.html#val-create"><code>create</code></a> for dynamically constructed queries, since it accepts the easily composible <a href="../Caqti_query/index.html#type-t"><code>Caqti_query.t</code></a> type instead of plain strings.</p><p>This scheme can be specialized for particular use cases, including generation of fragments of the <code>query</code>, which reduces the risk of wrongly matching up parameters with their uses in the query string.</p></header></section></div></body></html>